# CoverallsMigrateToGitHubApp

This gem helps you migrate large numbers of Coveralls repositories from OAuth App access to the Coveralls Official GitHub App. For organizations with fewer than 100 repositories, the standard GitHub UI migration workflow at https://coveralls.io can be used. However, GitHub's UI has a limit of 100 repositories when selecting "Selected Repositories" during app installation. We've provided this gem to help organizations with more than 100 repositories migrate all at once.

When using the gem, you'll need to provide:
- A Coveralls Personal API Token
- A GitHub Personal Access Token

Both tokens will never leave your local machine, as everything the gem does is executed in your local environment.

### What does it do?

The gem performs the following steps:

1. Validates your Coveralls Personal API Token and GitHub Personal Access Token
2. Fetches the list of repositories for your organization from Coveralls
3. Finds the Coveralls Official GitHub App installation for your organization
4. For each repository not yet using the GitHub App:
   - Adds the repository to the Coveralls Official GitHub App installation
   - Reports success or failure for each repository
5. Provides a summary report of the migration

**Note:** This tool does NOT remove or disable the OAuth App integration. Users can manually disable OAuth access through Coveralls if desired.

### Requirements

To use this gem, you'll need:

- Ruby >= 2.5.0
- Admin access to your GitHub organization
- Coveralls account access

## 1. Install the gem

```bash
gem install coveralls_migrate_to_github_app
```

## 2. Generate a Coveralls Personal API Token

1. Log in to Coveralls at https://coveralls.io
2. Visit your Account page: https://coveralls.io/account
3. Locate the "Personal API Tokens" section
4. Click "Generate Token" or copy your existing token
5. Save this token securely - you'll need it in step 4

## 3. Generate a GitHub Personal Access Token

Visit [GitHub Settings > Personal Access Tokens](https://github.com/settings/tokens) to generate a new token. This token must be generated by an **owner** of the GitHub organization containing repositories to be migrated.

Required scopes:
- `repo` - Full control of private repositories
- `admin:org` - Full control of organizations
- `admin:repo_hook` - Full control of repository hooks

![GitHub new personal access token](assets/new_personal_access_token.png)

Give your token a descriptive name (e.g., "Coveralls Migration Tool"), click 'Generate token', and save it securely. GitHub will only display this token once.

![Personal access tokens](assets/personal_access_tokens.png)

## 4. Install the Coveralls Official GitHub App

Before running the migration, you must install the Coveralls Official GitHub App to your organization:

1. Log in to Coveralls at https://coveralls.io
2. Navigate to the "Add Repos" section
3. Install the "Coveralls Official" GitHub App for your organization
4. You can start with "Only select repositories" and choose just one repository, or install it for all repositories
5. The migration tool will add additional repositories to this installation

**Alternative:** You can install the app directly at https://github.com/apps/coveralls-official

![Repository access](assets/repo_access.png)

## 5. Run the migration

```bash
coveralls_migrate_to_github_app start \
  --coveralls-token=<YOUR_COVERALLS_PAT> \
  --github-token=<YOUR_GITHUB_PAT> \
  --org-name=<GITHUB_ORG_NAME>
```

**Parameters:**
- `--coveralls-token`: Your Coveralls Personal API Token from step 2
- `--github-token`: The GitHub Personal Access Token generated in step 3
- `--org-name`: Your GitHub organization name (e.g., "coverallsapp")

**Example:**

```bash
coveralls_migrate_to_github_app start \
  --coveralls-token=coveralls_pat_abc123xyz \
  --github-token=github_pat_11A...xyz \
  --org-name=mycompany
```

### Expected Output

```
Found 150 repositories to migrate
✓ Added mycompany/repo1 to Coveralls Official GitHub App
✓ Added mycompany/repo2 to Coveralls Official GitHub App
...
============================================================
Migration Summary:
  Total repositories: 150
  Successfully migrated: 148
  Failed: 2

✓ Migration complete!
============================================================
```

## Troubleshooting

### "Coveralls Official GitHub App not found"
Make sure you've installed the Coveralls Official GitHub App for your organization (Step 4).

### "Error authenticating to GitHub"
Verify your GitHub token has the required scopes (`repo`, `admin:org`, `admin:repo_hook`) and hasn't expired.

### "Error validating Coveralls token"
Check that your Coveralls Personal API Token is correct and hasn't been revoked.

### Individual repositories fail to migrate
Ensure the GitHub token owner has admin access to those specific repositories. Some repositories may have different permission settings.

## Getting Help

Need assistance? Contact us:
- Email: support@coveralls.io
- GitHub Issues: https://github.com/coverallsapp/migrate_to_github_app/issues

## Contributing

Bug reports and pull requests are welcome on GitHub at https://github.com/coverallsapp/migrate_to_github_app. This project is intended to be a safe, welcoming space for collaboration, and contributors are expected to adhere to the [Contributor Covenant](http://contributor-covenant.org) code of conduct.

## License

The gem is available as open source under the terms of the [MIT License](https://opensource.org/licenses/MIT).

## Code of Conduct

Everyone interacting in the CoverallsMigrateToGitHubApp project's codebases, issue trackers, chat rooms and mailing lists is expected to follow the [code of conduct](https://github.com/coverallsapp/migrate_to_github_app/blob/master/CODE_OF_CONDUCT.md).
